<!doctype html>
<meta charset="utf-8" />
<title>LAN Popup Messenger + Tic-Tac-Toe</title>
<style>
  :root{ --w:520px; --line:#dadada; --card:#f7f7f7; --ok:#0a0; --warn:#b8860b; }
  body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:#fff; color:#111; }
  main{ max-width:var(--w); margin:24px auto; padding:0 14px; }
  h1{ font-size:1.25rem; margin:.25rem 0 .6rem; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  input, button{ padding:.55rem .7rem; border:1px solid var(--line); border-radius:10px; }
  input{ flex:1; min-width:160px; }
  button{ background:#fff; cursor:pointer; }
  .pill{ font-size:.8rem; padding:.2rem .6rem; border-radius:999px; border:1px solid var(--line); }
  .ok{ color:var(--ok); border-color:var(--ok); }
  .warn{ color:var(--warn); border-color:var(--warn); }
  .card{ background:#f7f7f7; border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
  .log{ background:#000; color:#0f0; border-radius:8px; padding:10px; height:160px; overflow:auto; font:12px/1.45 ui-monospace,Consolas,Menlo,monospace; white-space:pre-wrap; }
  .msg{ border:1px solid var(--line); border-radius:10px; padding:8px; margin:6px 0; }
  .me{ background:#eef9ee; }
  .them{ background:#eef2ff; }

  .banner{ position:fixed; left:50%; transform:translateX(-50%); top:12px; background:#111; color:#fff; padding:10px 14px;
           border-radius:999px; box-shadow:0 8px 24px rgba(0,0,0,.2); opacity:0; transition:.25s; pointer-events:none; }
  .banner.show{ opacity:1; }

  /* Tic-Tac-Toe */
  .ttt-wrap{ display:flex; flex-direction:column; align-items:center; gap:8px; }
  .ttt-status{ font-weight:600; }
  .ttt-board{ display:grid; grid-template-columns:repeat(3, 88px); gap:8px; }
  .ttt-cell{ width:88px; height:88px; border-radius:14px; display:flex; align-items:center; justify-content:center;
             background:#fff; border:1px solid var(--line); font:700 42px/1.1 ui-sans-serif, system-ui; cursor:pointer; }
  .ttt-cell.disabled{ cursor:not-allowed; background:#fafafa; }
</style>

<main>
  <h1>LAN Popup Messenger + Tic-Tac-Toe</h1>

  <div class="row">
    <span id="state" class="pill warn">Disconnected</span>
    <span id="roomTag" class="pill">Room: default</span>
    <span id="roleTag" class="pill">Role: ?</span>
  </div>

  <div class="card">
    <div class="row">
      <input id="host" placeholder="ws://192.168.1.50:8080" />
      <input id="room" placeholder="room name (optional)" />
      <button id="connect">Connect</button>
      <button id="disconnect" disabled>Disconnect</button>
      <button id="notify">Enable Notifications</button>
    </div>
    <div class="row" style="margin-top:.4rem">
      <input id="text" placeholder="Type messageâ€¦" />
      <button id="send" disabled>Send</button>
    </div>
  </div>

  <div class="card">
    <strong>Messages</strong>
    <div id="messages"></div>
  </div>

  <div class="card">
    <div class="ttt-wrap">
      <div class="ttt-status" id="tttStatus">Join with another player. X goes first.</div>
      <div class="ttt-board" id="tttBoard"></div>
      <div class="row" style="justify-content:center">
        <button id="tttReset" disabled>Reset Game</button>
      </div>
    </div>
  </div>

  <div class="card">
    <strong>Event Log</strong>
    <pre id="log" class="log"></pre>
  </div>
</main>

<div id="banner" class="banner"></div>

<script>
(function(){
  // Helpers (no contractions in log text)
  let $, log, banner;
  (function(){
    const byId = id => document.getElementById(id);
    window.$ = $ = byId;
    window.log = log = (m)=>{ const el=$('log'); el.textContent += m + "\\n"; el.scrollTop = el.scrollHeight; };
    window.banner = banner = (msg)=>{ const b = $('banner'); b.textContent = msg; b.classList.add('show'); setTimeout(()=> b.classList.remove('show'), 1500); };
  })();

  // WebSocket + chat
  let ws = null, myId = null, currentRoom = "default";
  function setState(ok){
    $('state').textContent = ok ? 'Connected' : 'Disconnected';
    $('state').className = 'pill ' + (ok ? 'ok' : 'warn');
    $('send').disabled = !ok;
    $('disconnect').disabled = !ok;
    $('connect').disabled = ok;
  }

  function addMsg(text, mine, meta){
    const box = document.createElement('div');
    box.className = 'msg ' + (mine ? 'me' : 'them');
    const time = new Date(meta?.at || Date.now()).toLocaleTimeString();
    const from = mine ? 'me' : (meta?.from || 'peer');
    box.textContent = `[${time}] ${from}: ${text}`;
    $('messages').appendChild(box);
    box.scrollIntoView({ behavior: 'smooth', block:'end' });
  }

  async function notify(title, body){
    try{ if (Notification.permission === 'granted') new Notification(title, { body }); }catch(_){}
  }
  $('notify').onclick = async ()=>{
    try{
      if (Notification.permission !== 'granted') await Notification.requestPermission();
      banner('Notifications: ' + Notification.permission);
    }catch(e){ log('Notification error: ' + e); }
  };

  $('connect').onclick = ()=>{
    const url = $('host').value.trim();
    currentRoom = ($('room').value.trim() || 'default');
    $('roomTag').textContent = 'Room: ' + currentRoom;
    if (!/^wss?:\/\//.test(url)) { alert('Enter ws://IP:PORT'); return; }
    ws = new WebSocket(url);
    ws.onopen = ()=>{ setState(true); log('Connected: ' + url); ws.send(JSON.stringify({ t:'join', room: currentRoom })); };
    ws.onerror = ()=> log('WebSocket error');
    ws.onclose = ()=>{ setState(false); log('Disconnected'); tttDisableAll(true); };
    ws.onmessage = onPacket;
  };
  $('disconnect').onclick = ()=>{ try{ ws && ws.close(); }catch(_){ } setState(false); };

  $('send').onclick = ()=>{
    const text = $('text').value.trim();
    if (!text || !ws || ws.readyState !== 1) return;
    ws.send(JSON.stringify({ t:'say', text }));
    $('text').value = '';
  };
  $('text').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') $('send').click(); });

  function onPacket(ev){
    let msg=null; try{ msg = JSON.parse(ev.data); }catch{ return; }

    if (msg.t === 'hello'){ myId = msg.id; log('Hello. Your id: ' + myId + '. LAN IPs: ' + (msg.ips||[]).join(', ')); return; }
    if (msg.t === 'roster'){ log('Room roster: players=' + msg.players.join(',') + ' spectators=' + msg.spectators); updateTTTInteract(); return; }
    if (msg.t === 'role'){
      const human = msg.role === 'X' ? 'X' : msg.role === 'O' ? 'O' : 'Spectator';
      $('roleTag').textContent = 'Role: ' + human;
      banner('You are ' + human);
      updateTTTInteract();
      return;
    }
    if (msg.t === 'msg'){
      const mine = (msg.from === myId);
      addMsg(msg.text, mine, msg);
      if (!mine) { banner('New message'); notify('LAN message', msg.text); }
      return;
    }
    if (msg.t === 'game'){
      if (msg.a === 'move'){ tttApplyMove(msg.idx, msg.by, true); }
      if (msg.a === 'reset'){ tttReset(true); }
      return;
    }
  }

  // ===== Tic-Tac-Toe =====
  const boardEl = $('tttBoard');
  const statusEl = $('tttStatus');
  let board = Array(9).fill(null);   // 'X', 'O', or null
  let turn  = 'X';                   // X starts

  // Build UI
  function renderBoard(){
    boardEl.innerHTML = '';
    for (let i=0; i<9; i++){
      const b = document.createElement('button');
      b.className = 'ttt-cell';
      b.dataset.idx = String(i);
      b.textContent = board[i] || '';
      b.addEventListener('click', ()=> onHumanMove(i));
      boardEl.appendChild(b);
    }
    updateTTTStatus();
    updateTTTInteract();
  }

  function updateTTTStatus(){
    const role = $('roleTag').textContent.replace('Role: ','');
    const w = winner(board);
    if (w){ statusEl.textContent = 'Winner: ' + w; }
    else if (drawState(board)){ statusEl.textContent = 'Draw.'; }
    else { statusEl.textContent = 'Turn: ' + turn + '  |  Your role: ' + role + '. X goes first.'; }
  }

  function tttDisableAll(block){
    const cells = boardEl.querySelectorAll('.ttt-cell');
    cells.forEach(el => el.classList.toggle('disabled', !!block));
    $('tttReset').disabled = !!block;
  }

  function updateTTTInteract(){
    const role = $('roleTag').textContent.includes('X') ? 'X' :
                 $('roleTag').textContent.includes('O') ? 'O' : 'S';
    const w = winner(board);
    const myTurn = (role !== 'S') && (turn === role) && !w && !drawState(board);
    const cells = boardEl.querySelectorAll('.ttt-cell');
    cells.forEach((el,i)=>{
      const occupied = !!board[i];
      el.classList.toggle('disabled', !myTurn || occupied);
    });
    $('tttReset').disabled = (role === 'S');
  }

  function onHumanMove(idx){
    const role = $('roleTag').textContent.includes('X') ? 'X' :
                 $('roleTag').textContent.includes('O') ? 'O' : 'S';
    if (role === 'S') return;
    if (turn !== role) return;
    if (board[idx]) return;
    tttApplyMove(idx, role, false);
    if (ws && ws.readyState === 1){
      ws.send(JSON.stringify({ t:'game', a:'move', idx, by: role }));
    }
  }

  function tttApplyMove(idx, by, remote){
    if (board[idx]) return;
    board[idx] = by;
    turn = (by === 'X') ? 'O' : 'X';
    renderBoard();
    const w = winner(board);
    if (w){ banner('Winner: ' + w); }
    else if (drawState(board)){ banner('Draw'); }
  }

  function winner(b){
    const L = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    for (const [a,c,d] of L){ if (b[a] && b[a]===b[c] && b[a]===b[d]) return b[a]; }
    return null;
  }
  function drawState(b){ return b.every(v=>v) && !winner(b); }

  function tttReset(remote){
    board = Array(9).fill(null);
    turn = 'X';
    renderBoard();
    if (!remote && ws && ws.readyState === 1){
      ws.send(JSON.stringify({ t:'game', a:'reset' }));
    }
  }
  $('tttReset').onclick = ()=> tttReset(false);

  renderBoard(); // initial paint
})();
</script>
